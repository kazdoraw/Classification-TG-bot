# ü§ñ Medical Image Analysis Telegram Bot

Telegram –±–æ—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∏ –æ–±—â–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≥–ª—É–±–æ–∫–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è.

## üìã –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. üî¨ –°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è —Å–µ—Ç—á–∞—Ç–∫–∏ (Retina Vessel Segmentation)
- **–ú–æ–¥–µ–ª—å:** U-Net
- **–¢–æ—á–Ω–æ—Å—Ç—å:** Dice 0.51
- **–§—É–Ω–∫—Ü–∏—è:** –í—ã–¥–µ–ª–µ–Ω–∏–µ –∫—Ä–æ–≤–µ–Ω–æ—Å–Ω—ã—Ö —Å–æ—Å—É–¥–æ–≤ –Ω–∞ —Å–Ω–∏–º–∫–∞—Ö –≥–ª–∞–∑–Ω–æ–≥–æ –¥–Ω–∞
- **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:** Overlay —Å –∫—Ä–∞—Å–Ω—ã–º–∏ —Å–æ—Å—É–¥–∞–º–∏

### 2. ü©∏ –î–µ—Ç–µ–∫—Ü–∏—è –∫–ª–µ—Ç–æ–∫ –∫—Ä–æ–≤–∏ (Blood Cell Detection)
- **–ú–æ–¥–µ–ª—å:** YOLOv8n
- **–¢–æ—á–Ω–æ—Å—Ç—å:** mAP50 0.935 (93.5%)
- **–ö–ª–∞—Å—Å—ã:** WBC, RBC, Platelets
- **–§—É–Ω–∫—Ü–∏—è:** –ü–æ–¥—Å—á—ë—Ç –∏ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–µ—Ç–æ–∫
- **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:** Bounding boxes —Å —Ü–≤–µ—Ç–∞–º–∏ –ø–æ —Ç–∏–ø–∞–º

### 3. üåÖ –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—Ü–µ–Ω (Scene Classification)
- **–ú–æ–¥–µ–ª—å:** ResNet-18
- **–¢–æ—á–Ω–æ—Å—Ç—å:** 85%+
- **–ö–ª–∞—Å—Å—ã:** 10 –∫–∞—Ç–µ–≥–æ—Ä–∏–π CIFAR-10
  - airplane, automobile, bird, cat, deer
  - dog, frog, horse, ship, truck
- **–§—É–Ω–∫—Ü–∏—è:** –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤
- **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:** Top-3 predictions

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
bot/
‚îú‚îÄ‚îÄ __init__.py          # Package initialization
‚îú‚îÄ‚îÄ main.py              # Entry point, bot initialization
‚îú‚îÄ‚îÄ config.py            # Configuration and messages
‚îú‚îÄ‚îÄ handlers.py          # Message and command handlers
‚îú‚îÄ‚îÄ models_loader.py     # Centralized models management
‚îî‚îÄ‚îÄ utils.py             # Helper functions

Workflow:
User ‚Üí Photo ‚Üí Primary Classifier ‚Üí [retina/blood/scene] ‚Üí Model ‚Üí Result
```

## üöÄ –ó–∞–ø—É—Å–∫

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–±—É—á–µ–Ω—ã –≤—Å–µ –º–æ–¥–µ–ª–∏:
```bash
# U-Net (–µ—Å–ª–∏ –µ—â—ë –Ω–µ –æ–±—É—á–µ–Ω)
./train_unet_retina.sh

# YOLOv8 (–µ—Å–ª–∏ –µ—â—ë –Ω–µ –æ–±—É—á–µ–Ω)
./train_blood_detector.sh

# CIFAR-10 (–µ—Å–ª–∏ –µ—â—ë –Ω–µ –æ–±—É—á–µ–Ω)
./train_cifar10_classifier.sh
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–æ–∫–µ–Ω–∞

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:
```bash
TELEGRAM_BOT_TOKEN=your_bot_token_here
```

–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω: [@BotFather](https://t.me/BotFather)

### 3. –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞

```bash
./run_bot.sh
```

–ò–ª–∏ –Ω–∞–ø—Ä—è–º—É—é:
```bash
conda activate ml-python312
python -m bot.main
```

## üì± –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ö–æ–º–∞–Ω–¥—ã

- `/start` - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É, –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
- `/help` - –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞

### –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ

1. –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ (JPG, PNG, –¥–æ 10 –ú–ë)
3. –ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
   - –û–ø—Ä–µ–¥–µ–ª–∏—Ç —Ç–∏–ø –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
   - –ü—Ä–∏–º–µ–Ω–∏—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –º–æ–¥–µ–ª—å
   - –í–µ—Ä–Ω—ë—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞

## üîÑ Pipeline –æ–±—Ä–∞–±–æ—Ç–∫–∏

```mermaid
graph TD
    A[User sends photo] --> B[Download & validate]
    B --> C[Primary Classifier]
    C -->|retina| D[U-Net Segmentation]
    C -->|blood| E[YOLO Detection]
    C -->|scene| F[CIFAR-10 Classification]
    D --> G[Return overlay + metrics]
    E --> H[Return annotated + counts]
    F --> I[Return top-3 predictions]
```

## üé® –ü—Ä–∏–º–µ—Ä—ã –æ—Ç–≤–µ—Ç–æ–≤

### Retina
```
üî¨ –°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è —Å–µ—Ç—á–∞—Ç–∫–∏

‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ!

üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
‚Ä¢ –°–æ—Å—É–¥—ã –≤—ã–¥–µ–ª–µ–Ω—ã –∫—Ä–∞—Å–Ω—ã–º —Ü–≤–µ—Ç–æ–º
‚Ä¢ –ü–ª–æ—â–∞–¥—å —Å–æ—Å—É–¥–æ–≤: 15.3%

–ú–µ—Ç–æ–¥: U-Net (Dice: 0.51)
```

### Blood
```
ü©∏ –î–µ—Ç–µ–∫—Ü–∏—è –∫–ª–µ—Ç–æ–∫ –∫—Ä–æ–≤–∏

‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ: 52 –æ–±—ä–µ–∫—Ç–∞

üìä –ü–æ–¥—Å—á—ë—Ç –∫–ª–µ—Ç–æ–∫:
**–í—Å–µ–≥–æ –∫–ª–µ—Ç–æ–∫:** 52

‚Ä¢ **WBC:** 2 (3.8%)
‚Ä¢ **RBC:** 45 (86.5%)
‚Ä¢ **Platelets:** 5 (9.6%)

–ú–æ–¥–µ–ª—å: YOLOv8n (mAP50: 0.935)
```

### Scene
```
üåÖ –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—Ü–µ–Ω—ã

‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç:** AIRPLANE
–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: 87.5%

üìä –¢–æ–ø-3 –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è:
ü•á **airplane** - 87.5%
ü•à **ship** - 8.2%
ü•â **bird** - 2.1%

–ú–æ–¥–µ–ª—å: ResNet-18 (Accuracy: 85%+)
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ `bot/config.py`:

```python
# Limits
MAX_FILE_SIZE_MB = 10
TIMEOUT_SECONDS = 30

# Model paths
MODEL_PATHS = {
    'primary': 'models/resnet18_primary/best_model.pth',
    'unet': 'models/unet_retina/best_model.pth',
    'yolo': 'models/yolov8_bccd/weights/best.pt',
    'cifar10': 'models/resnet18_cifar10/best_model.pth'
}
```

## üîß –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **–§—Ä–µ–π–º–≤–æ—Ä–∫:** aiogram 3.x (async)
- **ML:** PyTorch, torchvision, ultralytics
- **Primary:** ResNet-18 (100% accuracy)
- **Segmentation:** U-Net (Dice 0.51)
- **Detection:** YOLOv8n (mAP50 0.935)
- **Classification:** ResNet-18 (85%+ accuracy)

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–æ–¥–µ–ª—å | –í—Ä–µ–º—è inference | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã |
|--------|----------------|-----------|
| Primary | ~0.1s | 11M |
| U-Net | ~1-2s | 7.8M |
| YOLOv8n | ~0.5-1s | 3M |
| CIFAR-10 | ~0.1s | 11M |

**Total processing time:** 5-15 —Å–µ–∫—É–Ω–¥ (–≤–∫–ª—é—á–∞—è download/upload)

## üêõ Troubleshooting

### Bot –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –≤ .env
cat .env

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ –º–æ–¥–µ–ª–µ–π
ls -la models/*/best_model.pth
ls -la models/yolov8_bccd/weights/best.pt
```

### –û—à–∏–±–∫–∏ inference
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
tail -f bot.log

# –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –º–æ–¥–µ–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ
python src/inference_primary.py
python src/inference_segmentation.py
python src/inference_detection.py
python src/inference_cifar10.py
```

### –ú–µ–¥–ª–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ GPU (–∏–∑–º–µ–Ω–∏—Ç–µ DEVICE –≤ `src/config.py`)
- –£–º–µ–Ω—å—à–∏—Ç–µ —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CPU load

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `bot.log`:
```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
tail -f bot.log

# –ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫
grep ERROR bot.log
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –¢–æ–∫–µ–Ω –±–æ—Ç–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `.env` (–Ω–µ –∫–æ–º–º–∏—Ç–∏—Ç—å!)
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–æ–≤ (10 –ú–ë)
- Timeout –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (30 —Å–µ–∫—É–Ω–¥)
- –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–õ–æ–≥–∏—Ä—É—é—Ç—Å—è:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –¢–∏–ø –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –û—à–∏–±–∫–∏

## üöÄ –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω–æ
```bash
./run_bot.sh
```

### –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
```bash
# Supervisor –∏–ª–∏ systemd
# Screen/tmux session
screen -S telegram-bot
./run_bot.sh
```

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [aiogram Documentation](https://docs.aiogram.dev/)
- [PyTorch Documentation](https://pytorch.org/docs/)
- [Ultralytics YOLO](https://docs.ultralytics.com/)

## ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å

- [x] –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–æ—Ç–∞
- [x] –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π
- [x] –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å real users
- [ ] Production deployment

---

**–ê–≤—Ç–æ—Ä:** Final Work Project  
**–í–µ—Ä—Å–∏—è:** 1.0.0  
**Python:** 3.12  
**–õ–∏—Ü–µ–Ω–∑–∏—è:** MIT
